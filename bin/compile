#!/bin/bash

set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

echo "-----> Installing unoserver buildpack"

# Function to install APT dependencies using Scalingo's apt-buildpack
install_apt_deps() {
  local build_dir="$1"
  local cache_dir="$2"
  local env_dir="$3"

  echo "-----> Installing dependencies with APT buildpack"

  # Create Aptfile with required packages
  cat >> "$build_dir/Aptfile" <<EOF
libreoffice-writer
python3-uno
libreoffice-script-provider-python
fonts-liberation
fonts-dejavu
netcat-openbsd
EOF

  apt_deps_buildpack_dir=$(mktemp -d apt_buildpack_XXXX)

  APT_BUILDPACK_URL="${APT_BUILDPACK_URL:-https://github.com/Scalingo/apt-buildpack}"
  git clone --depth=1 "$APT_BUILDPACK_URL" "$apt_deps_buildpack_dir"

  "${apt_deps_buildpack_dir}/bin/compile" "$build_dir" "$cache_dir" "$env_dir"

  rm -rf "$apt_deps_buildpack_dir"
}

# Function to install Python dependencies using Scalingo's python-buildpack
install_python_deps() {
  local build_dir="$1"
  local cache_dir="$2"
  local env_dir="$3"

  echo "-----> Installing Python dependencies with Python buildpack"

  # Create requirements.txt with unoserver if it doesn't exist
  if [ ! -f "$build_dir/requirements.txt" ]; then
    cat > "$build_dir/requirements.txt" <<EOF
unoserver
EOF
  fi

  python_buildpack_dir=$(mktemp -d python_buildpack_XXXX)

  PYTHON_BUILDPACK_URL="${PYTHON_BUILDPACK_URL:-https://github.com/Scalingo/python-buildpack}"
  git clone --depth=1 "$PYTHON_BUILDPACK_URL" "$python_buildpack_dir"

  "${python_buildpack_dir}/bin/compile" "$build_dir" "$cache_dir" "$env_dir"

  rm -rf "$python_buildpack_dir"
}

# Install APT dependencies
install_apt_deps "$BUILD_DIR" "$CACHE_DIR" "$ENV_DIR"

# Install Python dependencies (unoserver)
install_python_deps "$BUILD_DIR" "$CACHE_DIR" "$ENV_DIR"

## Install custom fonts if they exist
#if [ -d "$BUILD_DIR/fonts" ]; then
#    echo "-----> Installing custom fonts"
#    mkdir -p /usr/share/fonts/truetype/custom/
#    cp "$BUILD_DIR/fonts/"* /usr/share/fonts/truetype/custom/ || true
#    fc-cache -f -v
#fi

# Make server.sh executable
if [ -f "$BUILD_DIR/server.sh" ]; then
    echo "-----> Making server.sh executable"
    chmod +x "$BUILD_DIR/server.sh"
fi

echo "-----> Build complete!"
