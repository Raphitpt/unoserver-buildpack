#!/bin/bash
set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

echo "-----> Installing unoserver buildpack"

# Répertoire d'installation du apt-buildpack
APT_DIR="$BUILD_DIR/.apt"

echo "-----> Debug: Listing installed APT binaries"
ls -la $BUILD_DIR/.apt/usr/bin || true

echo "-----> Debug: Checking Python installation"
ls -la $BUILD_DIR/.apt/usr/bin/python* || true

# Vérifie que python3 du apt-buildpack existe
if [ ! -f "$APT_DIR/usr/bin/python3" ]; then
  echo "ERROR: python3 not found in $APT_DIR/usr/bin/"
  echo "Make sure apt-buildpack is listed BEFORE this buildpack in .buildpacks"
  echo "and that your Aptfile includes: python3, python3-pip, python3-uno, libreoffice"
  exit 1
fi

# Configuration environnement pour l'installation pip
export PATH="$APT_DIR/usr/bin:$APT_DIR/usr/sbin:$PATH"
export LD_LIBRARY_PATH="$APT_DIR/lib/x86_64-linux-gnu:$APT_DIR/usr/lib/x86_64-linux-gnu:$APT_DIR/usr/lib/i386-linux-gnu:$APT_DIR/lib:$APT_DIR/usr/lib:${LD_LIBRARY_PATH:-}"
export LIBRARY_PATH="$APT_DIR/lib/x86_64-linux-gnu:$APT_DIR/usr/lib/x86_64-linux-gnu:$APT_DIR/usr/lib/i386-linux-gnu:$APT_DIR/lib:$APT_DIR/usr/lib:${LIBRARY_PATH:-}"
export INCLUDE_PATH="$APT_DIR/usr/include:$APT_DIR/usr/include/x86_64-linux-gnu:${INCLUDE_PATH:-}"
export PKG_CONFIG_PATH="$APT_DIR/usr/lib/x86_64-linux-gnu/pkgconfig:$APT_DIR/usr/lib/i386-linux-gnu/pkgconfig:$APT_DIR/usr/lib/pkgconfig:${PKG_CONFIG_PATH:-}"
export PYTHONPATH="$APT_DIR/usr/lib/python3/dist-packages:$APT_DIR/usr/lib/python3.*/dist-packages:${PYTHONPATH:-}"

# Debug: vérifier que Python fonctionne
echo "-----> Testing Python installation"
"$APT_DIR/usr/bin/python3" --version || {
  echo "ERROR: Python3 cannot execute"
  ldd "$APT_DIR/usr/bin/python3" || true
  exit 1
}

# Détection de la version Python
PYTHON_VERSION=$("$APT_DIR/usr/bin/python3" -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')" 2>&1)
if [ $? -ne 0 ]; then
  echo "ERROR: Cannot detect Python version"
  echo "$PYTHON_VERSION"
  exit 1
fi

echo "-----> Detected Python ${PYTHON_VERSION}"

# Installation de unoserver dans un dossier local
PYTHON_SITE_PACKAGES="$BUILD_DIR/.local/lib/python${PYTHON_VERSION}/site-packages"
mkdir -p "$PYTHON_SITE_PACKAGES"

# Vérifier que pip est disponible
echo "-----> Checking pip availability"
"$APT_DIR/usr/bin/python3" -m pip --version || {
  echo "ERROR: pip module not available"
  echo "Make sure python3-pip is in your Aptfile"
  exit 1
}

echo "-----> Installing unoserver (Python ${PYTHON_VERSION})..."

# Installer d'abord pip/setuptools/wheel
"$APT_DIR/usr/bin/python3" -m pip install \
  --no-cache-dir \
  --target="$PYTHON_SITE_PACKAGES" \
  --upgrade \
  pip setuptools wheel 2>&1 | sed 's/^/       /'

# Installer unoserver
"$APT_DIR/usr/bin/python3" -m pip install \
  --no-cache-dir \
  --target="$PYTHON_SITE_PACKAGES" \
  unoserver 2>&1 | sed 's/^/       /'

# Vérifier l'installation
if [ -d "$PYTHON_SITE_PACKAGES/unoserver" ] || [ -f "$PYTHON_SITE_PACKAGES/unoserver.py" ]; then
  echo "-----> unoserver installed successfully"
else
  echo "ERROR: unoserver installation failed"
  ls -la "$PYTHON_SITE_PACKAGES" | head -n 20
  exit 1
fi

# Configuration du profil d'exécution
echo "-----> Configuring runtime environment"
PROFILE_PATH="$BUILD_DIR/.profile.d/unoserver.sh"
mkdir -p "$(dirname "$PROFILE_PATH")"

cat > "$PROFILE_PATH" <<EOF
# unoserver runtime environment
export PATH="/app/.apt/usr/bin:/app/.apt/usr/sbin:\$PATH"
export LD_LIBRARY_PATH="/app/.apt/lib/x86_64-linux-gnu:/app/.apt/usr/lib/x86_64-linux-gnu:/app/.apt/usr/lib/i386-linux-gnu:/app/.apt/lib:/app/.apt/usr/lib:\$LD_LIBRARY_PATH"
export LIBRARY_PATH="/app/.apt/lib/x86_64-linux-gnu:/app/.apt/usr/lib/x86_64-linux-gnu:/app/.apt/usr/lib/i386-linux-gnu:/app/.apt/lib:/app/.apt/usr/lib:\$LIBRARY_PATH"
export INCLUDE_PATH="/app/.apt/usr/include:/app/.apt/usr/include/x86_64-linux-gnu:\$INCLUDE_PATH"
export PKG_CONFIG_PATH="/app/.apt/usr/lib/x86_64-linux-gnu/pkgconfig:/app/.apt/usr/lib/i386-linux-gnu/pkgconfig:/app/.apt/usr/lib/pkgconfig:\$PKG_CONFIG_PATH"
export PYTHONPATH="/app/.local/lib/python${PYTHON_VERSION}/site-packages:/app/.apt/usr/lib/python3/dist-packages:\$PYTHONPATH"
EOF

# Exporter les variables pour les buildpacks suivants
echo "-----> Exporting environment for subsequent buildpacks"
cat >> "$BUILD_DIR/.profile.d/unoserver.sh" <<EOF

# Export pour build time
export PATH="/app/.apt/usr/bin:/app/.apt/usr/sbin:\$PATH"
export PYTHONPATH="/app/.local/lib/python${PYTHON_VERSION}/site-packages:/app/.apt/usr/lib/python3/dist-packages:\$PYTHONPATH"
EOF

echo "-----> unoserver buildpack installation complete!"
echo "-----> Verifying installation:"
"$APT_DIR/usr/bin/python3" -c "import sys; sys.path.insert(0, '$PYTHON_SITE_PACKAGES'); import unoserver; print('unoserver version:', unoserver.__version__)" 2>&1 | sed 's/^/       /' || echo "       (version check failed, but installation may still work)"