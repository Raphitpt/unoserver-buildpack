#!/bin/bash
set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

# Load common functions
BP_DIR=$(cd "$(dirname "$0")"; cd ..; pwd)
source "${BP_DIR}/lib/apt.sh"

topic "Installing LibreOffice for unoserver"

# Liste des dépendances APT nécessaires
APT_DEPS="python3-uno libreoffice-core libreoffice-writer libreoffice-calc libreoffice-impress"

# Installer les dépendances via apt-buildpack
apt_install "${APT_DEPS}" "${BUILD_DIR}" "${CACHE_DIR}" "${ENV_DIR}"

APT_DIR="$BUILD_DIR/.apt"

# Configuration du profil d'exécution
topic "Configuring runtime environment"
PROFILE_PATH="$BUILD_DIR/.profile.d/libreoffice.sh"
mkdir -p "$(dirname "$PROFILE_PATH")"

cat > "$PROFILE_PATH" <<'EOF'
# LibreOffice runtime environment
export PATH="/app/.apt/usr/bin:/app/.apt/usr/sbin:$PATH"
export LD_LIBRARY_PATH="/app/.apt/lib/x86_64-linux-gnu:/app/.apt/usr/lib/x86_64-linux-gnu:/app/.apt/usr/lib/i386-linux-gnu:/app/.apt/lib:/app/.apt/usr/lib:$LD_LIBRARY_PATH"
EOF

# Ajouter python3-uno au PYTHONPATH
for pydir in "$APT_DIR"/usr/lib/python3*; do
  if [ -d "$pydir/dist-packages" ]; then
    PYVER=$(basename "$pydir")
    echo "export PYTHONPATH=\"/app/.apt/usr/lib/$PYVER/dist-packages:\$PYTHONPATH\"" >> "$PROFILE_PATH"
  fi
done

topic "LibreOffice installation complete!"