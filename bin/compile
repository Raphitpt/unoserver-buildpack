#!/bin/bash
set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

echo "-----> Installing unoserver buildpack"

# Répertoire d'installation du apt-buildpack
APT_DIR="$BUILD_DIR/.apt"

echo "-----> Debug: Full APT structure"
find "$APT_DIR" -name "python*" -type f 2>/dev/null | head -n 20 || true

echo "-----> Debug: Checking for Python in various locations"
ls -la "$APT_DIR/usr/bin/python"* 2>/dev/null || echo "No python in usr/bin"
ls -la "$APT_DIR/bin/python"* 2>/dev/null || echo "No python in bin"

# Chercher python3 dans tous les chemins possibles
PYTHON_BIN=""
for path in "$APT_DIR/usr/bin/python3" "$APT_DIR/bin/python3" "$APT_DIR/usr/bin/python3.10" "$APT_DIR/usr/bin/python3.12"; do
  if [ -f "$path" ]; then
    PYTHON_BIN="$path"
    echo "-----> Found Python at: $PYTHON_BIN"
    break
  fi
done

if [ -z "$PYTHON_BIN" ]; then
  echo "ERROR: python3 not found anywhere in $APT_DIR"
  echo "-----> Listing all .apt contents:"
  find "$APT_DIR" -type f -name "*python*" 2>/dev/null || true
  echo ""
  echo "Make sure apt-buildpack is listed BEFORE this buildpack in .buildpacks"
  echo "and that your Aptfile includes: python3, python3-pip, python3-uno, libreoffice"
  exit 1
fi

# Configuration environnement
export PATH="$APT_DIR/usr/bin:$APT_DIR/usr/sbin:$APT_DIR/bin:$PATH"
export LD_LIBRARY_PATH="$APT_DIR/lib/x86_64-linux-gnu:$APT_DIR/usr/lib/x86_64-linux-gnu:$APT_DIR/usr/lib/i386-linux-gnu:$APT_DIR/lib:$APT_DIR/usr/lib:${LD_LIBRARY_PATH:-}"
export LIBRARY_PATH="$APT_DIR/lib/x86_64-linux-gnu:$APT_DIR/usr/lib/x86_64-linux-gnu:$APT_DIR/usr/lib/i386-linux-gnu:$APT_DIR/lib:$APT_DIR/usr/lib:${LIBRARY_PATH:-}"
export PYTHONPATH="$APT_DIR/usr/lib/python3/dist-packages:${PYTHONPATH:-}"

# Ajouter tous les chemins python possibles au PYTHONPATH
for pydir in "$APT_DIR"/usr/lib/python3.*; do
  if [ -d "$pydir/dist-packages" ]; then
    export PYTHONPATH="$pydir/dist-packages:$PYTHONPATH"
  fi
done

echo "-----> Testing Python installation"
"$PYTHON_BIN" --version || {
  echo "ERROR: Python3 cannot execute"
  ldd "$PYTHON_BIN" || true
  exit 1
}

# Détection de la version Python
PYTHON_VERSION=$("$PYTHON_BIN" -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')" 2>&1)
if [ $? -ne 0 ]; then
  echo "ERROR: Cannot detect Python version"
  echo "$PYTHON_VERSION"
  exit 1
fi

echo "-----> Detected Python ${PYTHON_VERSION}"

# Installation de unoserver
PYTHON_SITE_PACKAGES="$BUILD_DIR/.local/lib/python${PYTHON_VERSION}/site-packages"
mkdir -p "$PYTHON_SITE_PACKAGES"

echo "-----> Checking pip availability"
"$PYTHON_BIN" -m pip --version 2>&1 || {
  echo "ERROR: pip module not available"
  echo "Attempting to install pip..."
  # Télécharger get-pip.py si pip n'est pas disponible
  curl -sS https://bootstrap.pypa.io/get-pip.py | "$PYTHON_BIN" - --target="$PYTHON_SITE_PACKAGES" || {
    echo "ERROR: Cannot install pip"
    exit 1
  }
  export PYTHONPATH="$PYTHON_SITE_PACKAGES:$PYTHONPATH"
}

echo "-----> Installing unoserver (Python ${PYTHON_VERSION})..."

# Installer unoserver
"$PYTHON_BIN" -m pip install \
  --no-cache-dir \
  --target="$PYTHON_SITE_PACKAGES" \
  --upgrade \
  pip setuptools wheel 2>&1 | sed 's/^/       /'

"$PYTHON_BIN" -m pip install \
  --no-cache-dir \
  --target="$PYTHON_SITE_PACKAGES" \
  unoserver 2>&1 | sed 's/^/       /'

# Vérifier l'installation
if [ ! -d "$PYTHON_SITE_PACKAGES/unoserver" ]; then
  echo "ERROR: unoserver installation failed"
  ls -la "$PYTHON_SITE_PACKAGES" | head -n 20
  exit 1
fi

echo "-----> unoserver installed successfully"

# Configuration du profil d'exécution
echo "-----> Configuring runtime environment"
PROFILE_PATH="$BUILD_DIR/.profile.d/unoserver.sh"
mkdir -p "$(dirname "$PROFILE_PATH")"

cat > "$PROFILE_PATH" <<EOF
# unoserver runtime environment
export PATH="/app/.apt/usr/bin:/app/.apt/usr/sbin:/app/.apt/bin:\$PATH"
export LD_LIBRARY_PATH="/app/.apt/lib/x86_64-linux-gnu:/app/.apt/usr/lib/x86_64-linux-gnu:/app/.apt/usr/lib/i386-linux-gnu:/app/.apt/lib:/app/.apt/usr/lib:\$LD_LIBRARY_PATH"
export PYTHONPATH="/app/.local/lib/python${PYTHON_VERSION}/site-packages:\$PYTHONPATH"

# Ajouter les chemins python du système
EOF

# Ajouter dynamiquement les chemins Python
for pydir in "$APT_DIR"/usr/lib/python3.*; do
  if [ -d "$pydir/dist-packages" ]; then
    PYVER=$(basename "$pydir")
    echo "export PYTHONPATH=\"/app/.apt/usr/lib/$PYVER/dist-packages:\$PYTHONPATH\"" >> "$PROFILE_PATH"
  fi
done

echo "-----> unoserver buildpack installation complete!"