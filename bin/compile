#!/bin/bash
set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

echo "-----> Installing unoserver buildpack"

# Répertoire d'installation du apt-buildpack
APT_DIR="$BUILD_DIR/.apt"

echo "-----> Debug: Listing installed APT binaries"
ls -la $BUILD_DIR/.apt/usr/bin || true
echo "-----> Debug: Listing installed APT libs"
ls -la $BUILD_DIR/.apt/usr/lib | head -n 20 || true


# Vérifie que python3 du apt-buildpack existe
if [ ! -f "$APT_DIR/usr/bin/python3" ]; then
  echo "ERROR: python3 not found in $APT_DIR/usr/bin/"
  echo "Make sure apt-buildpack is listed BEFORE this buildpack in .buildpacks"
  echo "and that your Aptfile includes: python3, python3-pip, python3-uno, libreoffice"
  exit 1
fi

# Configuration environnement pour l’installation pip
export PATH="$APT_DIR/usr/bin:$PATH"
export LD_LIBRARY_PATH="$APT_DIR/usr/lib/x86_64-linux-gnu:$APT_DIR/usr/lib:$LD_LIBRARY_PATH"

# Installation de unoserver dans un dossier local
PYTHON_SITE_PACKAGES="$BUILD_DIR/.local/lib/python3/site-packages"
mkdir -p "$PYTHON_SITE_PACKAGES"

echo "-----> Installing unoserver (with system Python from apt-buildpack)..."
"$APT_DIR/usr/bin/python3" -m pip install --no-cache-dir --target="$PYTHON_SITE_PACKAGES" unoserver

# Configuration du profil d’exécution
echo "-----> Configuring runtime environment"
PROFILE_PATH="$BUILD_DIR/.profile.d/unoserver.sh"
mkdir -p "$(dirname "$PROFILE_PATH")"

cat > "$PROFILE_PATH" <<'EOF'
# unoserver runtime environment
export PYTHONPATH="/app/.local/lib/python3/site-packages:$PYTHONPATH"
export LD_LIBRARY_PATH="/app/.apt/usr/lib/x86_64-linux-gnu:/app/.apt/usr/lib:$LD_LIBRARY_PATH"
EOF

echo "-----> unoserver buildpack installation complete!"
