#!/bin/bash

set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

echo "-----> Installing unoserver buildpack"

# Function to install APT dependencies using Scalingo's apt-buildpack
install_apt_deps() {
  local build_dir="$1"
  local cache_dir="$2"
  local env_dir="$3"

  echo "-----> Installing dependencies with APT buildpack"

  # Create Aptfile with required packages
  cat >> "$build_dir/Aptfile" <<EOF
python3-pip
libreoffice-writer
python3-uno
libreoffice-script-provider-python
fonts-liberation
fonts-dejavu
netcat-openbsd
EOF

  apt_deps_buildpack_dir=$(mktemp -d apt_buildpack_XXXX)

  APT_BUILDPACK_URL="${APT_BUILDPACK_URL:-https://github.com/Scalingo/apt-buildpack}"
  git clone --depth=1 "$APT_BUILDPACK_URL" "$apt_deps_buildpack_dir"

  "${apt_deps_buildpack_dir}/bin/compile" "$build_dir" "$cache_dir" "$env_dir"

  rm -rf "$apt_deps_buildpack_dir"
}

# Install APT dependencies
install_apt_deps "$BUILD_DIR" "$CACHE_DIR" "$ENV_DIR"

# Install unoserver via pip
echo "-----> Installing unoserver"
pip3 install --break-system-packages unoserver

# Install custom fonts if they exist
if [ -d "$BUILD_DIR/fonts" ]; then
    echo "-----> Installing custom fonts"
    mkdir -p /usr/share/fonts/truetype/custom/
    cp "$BUILD_DIR/fonts/"* /usr/share/fonts/truetype/custom/ || true
    fc-cache -f -v
fi

# Install Bun if not already installed
if ! command -v bun &> /dev/null; then
    echo "-----> Installing Bun"
    curl -fsSL https://bun.sh/install | bash
    export BUN_INSTALL="$HOME/.bun"
    export PATH="$BUN_INSTALL/bin:$PATH"
fi

# Install application dependencies
if [ -f "$BUILD_DIR/package.json" ]; then
    echo "-----> Installing application dependencies with Bun"
    cd "$BUILD_DIR"
    bun install
fi

# Make server.sh executable
if [ -f "$BUILD_DIR/server.sh" ]; then
    echo "-----> Making server.sh executable"
    chmod +x "$BUILD_DIR/server.sh"
fi

echo "-----> Build complete!"
