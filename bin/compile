#!/bin/sh
set -e
[ -n "$BUILDPACK_DEBUG" ] && set -x

BUILD_DIR=$1
CACHE_DIR=$2
VENDOR_DIR="$BUILD_DIR/vendor"
LIBRE_OFFICE_DIR="$VENDOR_DIR/libreoffice"

echo "-----> Setting up LibreOffice + unoserver"

# --- Vérifications de base ---
if [ ! -d "$LIBRE_OFFICE_DIR" ]; then
  echo "ERROR: LibreOffice not found in $LIBRE_OFFICE_DIR"
  echo "Make sure the LibreOffice buildpack is listed BEFORE unoserver buildpack"
  exit 1
fi

LIBRE_OFFICE_VERSION=$(ls "$LIBRE_OFFICE_DIR/opt")
APPDIR="$LIBRE_OFFICE_DIR/opt/$LIBRE_OFFICE_VERSION"
PROGRAM_DIR="$APPDIR/program"
PYTHON="$PROGRAM_DIR/python"

echo "-----> Found LibreOffice $LIBRE_OFFICE_VERSION"
echo "-----> Using LibreOffice's Python: $PYTHON"

# --- Préparer pip ---
PYTHON_VERSION=$("$PYTHON" --version 2>&1 | grep -oP '\d+\.\d+' | head -1)
GET_PIP_FILE="$CACHE_DIR/get-pip-$PYTHON_VERSION.py"
GET_PIP_URL="https://bootstrap.pypa.io/get-pip.py"

if [ ! -e "$GET_PIP_FILE" ]; then
  echo "-----> Downloading get-pip.py"
  curl -sSL "$GET_PIP_URL" -o "$GET_PIP_FILE"
fi

# --- Environnement UNO nécessaire ---
export URE_BOOTSTRAP="vnd.sun.star.pathname:$PROGRAM_DIR/fundamentalrc"
export UNO_PATH="$PROGRAM_DIR"
export LD_LIBRARY_PATH="$APPDIR/lib:$APPDIR/usr/lib:$LD_LIBRARY_PATH"
export PYTHONPATH="$PROGRAM_DIR"
export SAL_USE_VCLPLUGIN=headless
export SAL_DISABLEGUI=1

# --- Installer pip et unoserver ---
echo "-----> Installing pip and unoserver"
"$PYTHON" "$GET_PIP_FILE" --no-warn-script-location
"$PYTHON" -m pip install --no-warn-script-location unoserver

# --- Trouver le répertoire python-core ---
PYTHON_CORE_VERSION=$(ls "$PROGRAM_DIR" | grep python-core | head -1)
UNO_BIN="$PROGRAM_DIR/$PYTHON_CORE_VERSION/bin"

# --- Créer le profil d'environnement pour Scalingo ---
PROFILE_PATH="$BUILD_DIR/.profile.d/unoserver.sh"
mkdir -p "$(dirname "$PROFILE_PATH")"
cat > "$PROFILE_PATH" <<EOF
# LibreOffice / UNO environment
export APPDIR="/app/vendor/libreoffice/opt/$LIBRE_OFFICE_VERSION"
export URE_BOOTSTRAP="vnd.sun.star.pathname:\$APPDIR/program/fundamentalrc"
export UNO_PATH="\$APPDIR/program"
export LD_LIBRARY_PATH="\$APPDIR/lib:\$APPDIR/usr/lib:\$LD_LIBRARY_PATH"
export PYTHONPATH="\$APPDIR/program"
export SAL_USE_VCLPLUGIN=headless
export SAL_DISABLEGUI=1
export LIBREOFFICE_PYTHON="\$APPDIR/program/python"
EOF

# --- Créer les wrappers binaires ---
BIN_DIR="$BUILD_DIR/bin"
mkdir -p "$BIN_DIR"

for TOOL in unoserver unoconvert unocompare; do
  echo "-----> Creating wrapper for $TOOL"
  cat > "$BIN_DIR/$TOOL" <<EOF
#!/bin/sh
APPDIR="/app/vendor/libreoffice/opt/$LIBRE_OFFICE_VERSION"
PROGRAM_DIR="\$APPDIR/program"
PYTHON_CORE_DIR=\$(ls "\$PROGRAM_DIR" | grep python-core | head -1)
UNO_BIN="\$PROGRAM_DIR/\$PYTHON_CORE_DIR/bin"

export URE_BOOTSTRAP="vnd.sun.star.pathname:\$PROGRAM_DIR/fundamentalrc"
export UNO_PATH="\$PROGRAM_DIR"
export LD_LIBRARY_PATH="\$APPDIR/lib:\$APPDIR/usr/lib:\$LD_LIBRARY_PATH"
export PYTHONPATH="\$PROGRAM_DIR"

exec "\$PROGRAM_DIR/python" "\$UNO_BIN/$TOOL" "\$@"
EOF
  chmod +x "$BIN_DIR/$TOOL"
done

echo "-----> unoserver installation complete!"
